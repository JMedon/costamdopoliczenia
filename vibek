Public Function max(a, b)If a > b Thenmax = aElsemax = bEnd IfEnd FunctionPublic Function AlgoSortNow(ByVal ile As Double, ByRef zmienna() As Double, ByRef zmienna2() As Double, ByRef sredniZyskALL As Double, ByRef typeALL As Double, ByRef progOne As Double, ByRef progTwo As Double) As DoubleDim Threshold As DoubleDim Threshold2 As DoubleThreshold = 0.1Threshold2 = 1.3Dim Ycum1 As Par, Xval1 As Par, QtoStart1 As Par, QtoEnd1 As Par, Ycum2 As Par, Xval2 As Par, QtoStart2 As Par, QtoEnd2 As ParDim Solution1 As DoubleDim Solution2 As DoubleDim Solution As DoubleDim SredniZysk1 As DoubleDim SredniZysk2 As DoubleDim SredniZyskABS1a As DoubleDim SredniZyskABS2a As DoubleDim SredniZyskABS1b As DoubleDim SredniZyskABS2b As DoubleDim type1 As Double ' 1=LS 2=SL 0=NADim type2 As Double ' 3=LSL 4=SLS 0=NADim type1a As DoubleDim type2a As DoubleDim progOne1 As Double, progTwo1 As Double, progOne2 As Double, progTwo2 As DoubleReDim Zysk1(0 To ile) As DoubleReDim Zysk2(0 To ile) As Double  Ycum1.min = 10000000000#Ycum1.max = -100000000000#'Generate Ycum1 Xval1 .min .max   For m = 1 To ile      '====zysk      Zysk1(m) = Val(zmienna2(m) + Zysk1(max(1, m - 1)))      '====min      If Val(Zysk1(m)) < Ycum1.min Then '         Ycum1.min = Zysk1(m)         Xval1.min = zmienna(m)         QtoStart1.min = m / ile               End If      '===max      If Val(Zysk1(m)) > Ycum1.max Then  '         Ycum1.max = Zysk1(m)         Xval1.max = zmienna(m)         QtoStart1.max = m / ile      End If    Next mYcum1.start = 0Ycum1.end = Zysk1(ile)QtoEnd1.min = 1 - QtoStart1.minQtoEnd1.max = 1 - QtoStart1.maxIf QtoStart1.min < Threshold Then    QtoStart1.start = 1Else    QtoStart1.start = 0End IfIf QtoStart1.max < Threshold Then    QtoStart1.end = 1Else    QtoStart1.end = 0End IfIf QtoEnd1.min < Threshold Then    QtoEnd1.start = 1Else    QtoEnd1.start = 0End IfIf QtoEnd1.max < Threshold Then    QtoEnd1.end = 1Else    QtoEnd1.end = 0End If'generate pomocnicze absIf QtoStart1.end + QtoEnd1.end = 0 ThenSredniZyskABS1a = Ycum1.max + Abs(Ycum1.max - Ycum1.end)ElseSredniZyskABS1a = 0End IfIf QtoStart1.start + QtoEnd1.start = 0 ThenSredniZyskABS1b = -Ycum1.min + Abs(Ycum1.min - Ycum1.end)ElseSredniZyskABS1b = 0End IfSredniZysk1 = max(SredniZyskABS1a, SredniZyskABS1b)'Generate type1If SredniZyskABS1a > SredniZyskABS1b Then    type1a = 1Else    type1a = 2End IfIf type1a = 2 Then    If QtoStart1.start + QtoEnd1.start > 0 Then    type1 = 0    Else    type1 = 2    End IfElse    If QtoStart1.end + QtoEnd1.end > 0 Then    type1 = 0    Else    type1 = 1    End IfEnd If'Generate progOne1If type1 = 2 Then    progOne1 = Xval1.minElse    progOne1 = Xval1.maxEnd If'Generate Solution1If SredniZysk1 / Abs(Ycum1.end) < Threshold2 Or type1 = 0 Then    Solution1 = 0Else    Solution1 = 1End If'Choose SolutionIf Solution1 = 0 And Solution2 = 0 Then    Solution = 0ElseIf Solution1 = 0 Then    Solution = 2ElseIf Solution2 = 0 Then    Solution = 1ElseIf SredniZysk1 > SredniZysk2 Then    Solution = 1Else        Solution = 2End If'Generate Final SolutionIf Solution = 0 Then    typeALL = 0    progOne = 0    progTwo = 0    sredniZyskALL = 0ElseIf Solution = 1 Then    typeALL = type1    progOne = progOne1    progTwo = 0    sredniZyskALL = Round(SredniZysk1 / ile, 4)Else    typeALL = type2    progOne = progOne2    progTwo = progTwo2    sredniZyskALL = SredniZysk2End IfAlgoSortNow = sredniZyskALL ' ZMIENIC NA SHARPE RATIO!!             End FunctionPublic Function wynikOutofSample(ByVal ile As Double, ByRef X_Out() As Double, ByRef Y_Out() As Double, ByRef K_nominal() As Double, ByRef K_Sharpe() As Double, ByRef InSampleSharpe As Double, ByRef sredniZysk As Double, ByRef sharpeRatio As Double, ByRef typeALL As Double, ByRef progOne As Double, ByRef progTwo As Double) As DoubleDim OutZysk As DoubleReDim Zysk(1 To ile) As DoubleReDim K_nominal(1 To ile) As DoubleReDim K_Sharpe(1 To ile) As DoubleFor u = 1 To ile    If typeALL = 1 Then        K_nominal(u) = Sgn(X_Out(u) - progOne)        Zysk(u) = K_nominal(u) * Y_Out(u)    ElseIf typeALL = 2 Then        K_nominal(u) = -Sgn(X_Out(u) - progOne)        Zysk(u) = K_nominal(u) * Y_Out(u)    ElseIf typeALL = 3 Then        If X_Out(u) < progOne Then            K_nominal(u) = 1            Zysk(u) = K_nominal(u) * Y_Out(u)        Else            K_nominal(u) = Sgn(X_Out(u) - progTwo)            Zysk(u) = K_nominal(u) * Y_Out(u)        End If    ElseIf typeALL = 4 Then        If X_Out(u) < progOne Then            K_nominal(u) = -1            Zysk(u) = K_nominal(u) * Y_Out(u)        Else            K_nominal(u) = -Sgn(X_Out(u) - progTwo)            Zysk(u) = K_nominal(u) * Y_Out(u)        End If    Else        K_nominal(u) = 0        Zysk(u) = 0    End If        OutZysk = OutZysk + Zysk(u)    K_Sharpe(u) = K_nominal(u) * InSampleSharpeNext usredniZysk = Round(OutZysk / ile, 4)sharpeRatio = Round(sredniZysk / StdDev(ile, Zysk()), 4) ' 'POPRAWICwynikOutofSample = Round(sharpeRatio, 4)             End Function'*********************************************************************** '*                                                       Mean                                                  * '*********************************************************************** Function Mean(k As Double, Arr() As Double)      Dim Sum As Double      Dim i As Integer      Sum = 0      For i = 1 To k          Sum = Sum + Arr(i)      Next i        Mean = Sum / k End Function'************************************************************************ '*                                              Standard Deviation                                    * '************************************************************************ Function StdDev(k As Double, Arr() As Double)      Dim i As Integer      Dim avg As Single, SumSq As Double       avg = Mean(k, Arr)      For i = 1 To k           SumSq = SumSq + (Arr(i) - avg) ^ 2      Next i        StdDev = Sqr(SumSq / (k - 1)) End Function
Global wynikInSample As Double, sredniZysk As Double, sharpeRatio As Double, sredniZyskALL As Double, typeALL As Double, progOne As Double, progTwo As DoublePublic Type Par   min As Double   max As Double   start As Double   end  As DoubleEnd TypeSub Algo1()   '---------------------------------------------------------------------------------------   ' Method : Algo   ' Author : Jakub Medon   ' Date   : 2016-11-24   ' Purpose: algo sort   ' TODO:   '   '   '        *Algosort   '        *dodanie nonstop L/ S do wyniku   '        *wygenerowanie wyniku do pliku   '        *wygenerowanie tasmy kierunkow do pliku   '        *   'Input Settings:   'inSample.start   'inSample.end   'outSample.end   '   'data   'X   'Y   '   'X_type - X variable type: nominal or return '1=nominal 2=returns   '      '--------------------------------------------------------------------------------------- '  On Error GoTo MojaProce_Error   With Application      .ScreenUpdating = False      .Calculation = xlCalculationManual      .UseSystemSeparators = False      .DecimalSeparator = "."   End With'-START---------------------------------------------------Dim inSample As ParDim outSample As ParinSample.start = 200001010000#inSample.end = 201501010000#outSample.end = 201601010000#'X_type = 2 '1=nominal 2=returns'####################### count rozmiarWierszy ######################'count number of event in variableSet fs = CreateObject("Scripting.FileSystemObject")PATCHstr = "C:\Users\medonj\MOJE\model sortowania\In"ChDir PATCHstrstrplik = Dir(PATCHstr & "\*.csv") '#    Open PATCHstr & "\" & strplik For Input As #3rozmiarWierszy = 0Do While Not EOF(3)    Line Input #3, Textline        rozmiarWierszy = rozmiarWierszy + 1LoopClose #3    '####################### 'read data ######################ReDim Temp(1 To rozmiarWierszy, 1 To 4) As DoubleReDim TempOut(1 To rozmiarWierszy, 1 To 4) As DoubleOpen PATCHstr & "\" & strplik For Input As #3i = 1e = 1X_Last = 0Do While Not EOF(3)    Line Input #3, Textline    Arrcells = Split(Textline, ",")    Data_temp = Val(Arrcells(0))    X_temp = Val(Arrcells(1))    Y_temp = Val(Arrcells(2))        'In sample data    If Data_temp > inSample.start And Data_temp < inSample.end And X_temp <> "" And Y_temp <> 0 Then        Temp(i, 1) = Data_temp        Temp(i, 2) = X_temp        Temp(i, 3) = Y_temp        Temp(i, 4) = X_temp - X_Last        i = i + 1    End If    X_Last = X_temp        'Out of sample data    If Data_temp >= inSample.end And Data_temp < outSample.end And X_temp <> "" And Y_temp <> 0 Then        TempOut(e, 1) = Data_temp        TempOut(e, 2) = X_temp        TempOut(e, 3) = Y_temp        TempOut(e, 4) = X_temp - X_Last        e = e + 1    End If    X_Last = X_tempLoopClose #3'####################### generate filtered variables ######################'rozmiarWierszy = irozmiarOut = e'in sampleReDim D(1 To rozmiarWierszy) As DoubleReDim X(1 To rozmiarWierszy) As DoubleReDim X_return(1 To rozmiarWierszy) As DoubleReDim Y(1 To rozmiarWierszy) As DoubleFor u = 1 To rozmiarWierszy    D(u) = Temp(u, 1)    X(u) = Temp(u, 2)    Y(u) = Temp(u, 3)    X_return(u) = Temp(u, 4)Next u'out of sampleReDim D_Out(1 To rozmiarOut) As DoubleReDim X_Out(1 To rozmiarOut) As DoubleReDim X_return_Out(1 To rozmiarOut) As DoubleReDim Y_Out(1 To rozmiarOut) As DoubleReDim K_nominal(1 To rozmiarOut) As DoubleReDim K_Sharpe(1 To rozmiarOut) As DoubleFor u = 1 To rozmiarOut    D_Out(u) = TempOut(u, 1)    X_Out(u) = TempOut(u, 2)    Y_Out(u) = TempOut(u, 3)    X_return_Out(u) = TempOut(u, 4)Next u'####################### Algo Sort nominal ######################'lewy = LBound(X, 1):    prawy = UBound(X, 1)SortowanieDwoch X, Y, lewy, prawywynikInSample = AlgoSortNow(rozmiarWierszy, X, Y, sredniZyskALL, typeALL, progOne, progTwo)Debug.Print "AlgoSort nominal:"; sredniZyskALL, typeALL, progOne, progTwowynikNominal = wynikOutofSample(rozmiarOut, X_Out, Y_Out, K_nominal, K_Sharpe, wynikInSample, sredniZysk, sharpeRatio, typeALL, progOne, progTwo)Debug.Print "wynik AlgoSort nominal: "; rozmiarOut; wynikNominal; wynikInSample; sredniZysk; sharpeRatio; typeALL; progOne; progTwo'####################### Algo Sort returns ######################'lewy = LBound(X, 1):    prawy = UBound(X, 1)SortowanieDwoch X_return, Y, lewy, prawywynikInSample = AlgoSortNow(rozmiarWierszy, X, Y, sredniZyskALL, typeALL, progOne, progTwo)Debug.Print "AlgoSort returns:"; sredniZyskALL, typeALL, progOne, progTwowynikReturns = wynikOutofSample(rozmiarOut, X_return_Out, Y_Out, K_nominal, K_Sharpe, wynikInSample, sredniZysk, sharpeRatio, typeALL, progOne, progTwo)Debug.Print "wynik AlgoSort returns: "; rozmiarOut; wynikReturns; wynikInSample; sredniZysk; sharpeRatio; typeALL; progOne; progTwo'-END---------------------------------------------------MojaProce_Error:   With Application      .Calculation = xlCalculationAutomatic      .ScreenUpdating = True      .CutCopyMode = False   End WithEnd Sub
Global nazwaRynku As String
Global optymalizacja As Double
Global rozmiarWierszy As Double
Global countmidDate As Double
Global countStartOutDate As Double
Global alfa As Double

Global mnoznik(1 To 178) As Double
Global prog(0 To 67) As Double
Global a(1 To 18) As Integer
Global b(1 To 18) As Integer
Global SL_L(1 To 18) As Integer
Global SL_S(1 To 18) As Integer
Global SL_Double(1 To 18) As Integer
Global alfaEMA(1 To 23) As Double


Global sRano As Integer
Global kierWdzien As Integer
Global sWieczor As Integer
Global sSL As Integer
Global trade As Double
Global tradeIn As Double

Public Type Par
   min As Double
   max As Double
   step As Double
   wide As Double
   best As Double
   i As Double
End Type

Dim sredniZyskF As Double, kierunekF As Double, progF As Double
Dim iTryb As Par, iSL1 As Par, iSL2 As Par, iEMA As Par, iHourDzien As Par, iHourNoc As Par, iprogDzien As Par, iprogNoc As Par
Dim pTick As Double
Dim pSpread As Double

Dim D() As Double
Dim t() As Double
Dim O() As Double
Dim h() As Double
Dim l() As Double
Dim C() As Double
Dim V() As Double
Dim Vwap() As Double
Dim countDays() As Double
Dim nowNewday() As Double
Dim now16() As Double
      
Dim timeDzien() As Double
Dim timeNoc() As Double
Dim cenaDzien() As Double
Dim cenaNoc() As Double

Dim EMA1() As Double
Dim trendEMA() As Double
Dim H1() As Double
Dim L1() As Double
Dim H11() As Double
Dim L11() As Double
Dim DzienSL() As Double
Dim bazaSL() As Double
Dim CenaBuySL() As Double
Dim CenaShortSL() As Double
Dim kierDzien() As Double
Dim kierNoc() As Double
Dim BuySL() As Double
Dim ShortSL() As Double
Dim Kierunek() As Double
Dim Cena() As Double
Dim ZyskCum() As Double
Dim Zysk() As Double
Dim PL() As Double

Dim luka() As Double
Dim Dzien() As Double
Dim luka1() As Double
Dim dzien1() As Double
Dim luka2() As Double
Dim dzien2() As Double

Sub BravoM15_B_GOTOWIEC_USA()
   '---------------------------------------------------------------------------------------
   ' Method : BravoM15_B
   ' Author : Jakub Medon
   ' Date   : 2016-05-28
   ' Purpose: Optimization "Bravo" intraday strategy m15
   '---------------------------------------------------------------------------------------
   startTime = Timer
   On Error GoTo MojaProce_Error
   With Application
      .ScreenUpdating = False
      .Calculation = xlCalculationManual
      .UseSystemSeparators = False
      .DecimalSeparator = "."
   End With


   startDate = 20130101:       midDate = 20160101:     startOutDate = 20160501
   optymalizacja = 0: iteracja = 0

   For i = 1 To 178 'zaimportowanie tablicy mnoznik
      If i <= 178 Then
         mnoznik(i) = Sheets("ustawienia").Cells(i + 1, 1)
      End If
      If i <= 68 Then
         prog(i - 1) = Sheets("ustawienia").Cells(i + 0, 2)
      End If
      If i <= 23 Then
         alfaEMA(i) = Sheets("ustawienia").Cells(i + 1, 3)
      End If
      If i <= 18 Then
         a(i) = Sheets("ustawienia").Cells(i + 1, 4)
         b(i) = Sheets("ustawienia").Cells(i + 1, 5)
         SL_L(i) = Sheets("ustawienia").Cells(i + 1, 6)
         SL_S(i) = Sheets("ustawienia").Cells(i + 1, 7)
         SL_Double(i) = Sheets("ustawienia").Cells(i + 1, 8)
      End If
   Next i

   '##########################################################
   '####################### IMPORT DATA ######################
   '##########################################################
   Set fs = CreateObject("Scripting.FileSystemObject")
   PATCHstr = "D:\BravoD1\"

   ChDir PATCHstr
   strplik = Dir(PATCHstr & "\*.txt") '#


   '   Open PATCHstr & "\new\" & "time1.txt" For Output As #7
   '   Print #7, "Wczytanie tablic: " & Round(Timer - startTime, 6)

  ' Do While strplik <> "" ' looopowanie po plikach
      For R = 1 To 1
      nazwaRynku = Sheets("Rynki").Cells(R, 1)
      strplik = "M15_" & nazwaRynku & ".txt" '"D:\BravoD1\
      '       splitStrPLik = Split(strplik, ".txt")
       '       nazwaRynku = splitStrPLik(0)
      Open PATCHstr & "\eq\" & nazwaRynku & "_equityUSAsimComAll1aHL4.txt" For Output As #5
      
      'Open PATCHstr & "\" & strplik For Input As #3
      'Close #3
      
      rozmiarWierszy = countRowsInFile(PATCHstr, strplik, ";", startDate, midDate, startOutDate)
      Open PATCHstr & "\new\" & nazwaRynku & "_wyniki_iteracjiUSAnoCommAll1aHL4.txt" For Output As #6
       
      'utworzenie tablic
      ReDim D(1 To rozmiarWierszy) As Double
      ReDim t(1 To rozmiarWierszy) As Double
      ReDim O(1 To rozmiarWierszy) As Double
      ReDim h(1 To rozmiarWierszy) As Double
      ReDim l(1 To rozmiarWierszy) As Double
      ReDim C(1 To rozmiarWierszy) As Double
      ReDim V(1 To rozmiarWierszy) As Double
      ReDim Vwap(1 To rozmiarWierszy) As Double
      ReDim countDays(1 To rozmiarWierszy) As Double
      ReDim nowNewday(1 To rozmiarWierszy) As Double
      ReDim now16(1 To rozmiarWierszy) As Double
      countDays(1) = 1

      'wczytanie danych
      Open PATCHstr & "\" & strplik For Input As #3
      i = 0
      Do While Not EOF(3)
         Line Input #3, Textline
         ArrCells = Split(Textline, ";")
         If Val(Left(ArrCells(0), 8)) > startDate And Val(Right(ArrCells(0), 4)) > 915 And Val(Right(ArrCells(0), 4)) < 1615 Then
            i = i + 1

            D(i) = Val(Left(ArrCells(0), 8))
            t(i) = Val(Right(ArrCells(0), 4))
            O(i) = Val(ArrCells(1))
            h(i) = Val(ArrCells(2))
            l(i) = Val(ArrCells(3))
            C(i) = Val(ArrCells(4))
            V(i) = Val(ArrCells(5))
            Vwap(i) = Val(ArrCells(5))

            countDays(i) = countDays(max(1, i - 1)) + IIf(D(i) <> D(max(1, i - 1)), 1, 0)
            nowNewday(i) = IIf(D(i) <> D(max(1, i - 1)), 1, 0)
            now16(i) = IIf(t(max(1, i - 1)) <= 1600 And t(i) >= 1600, 1, 0)
                
            '  If Val(Left(ArrCells(0), 8)) > midDate Then
            '      'POLICZENIE NAJMNIEJSZEGO TICKA
            '      If Val((h(i) - O(i))) = 0 Then
            '          min1 = 100
            '      Else: min1 = Abs(h(i) - O(i))
            '      End If
            '      If Val((C(i) - O(i))) = 0 Then
            '          min2 = 100
            '      Else: min2 = Abs(C(i) - O(i))
            '      End If
            '      If Val((l(i) - O(i))) = 0 Then
            '          min3 = 100
            '     Else: min3 = Abs(l(i) - O(i))
            '     End If
            '     Increment = min(Increment, min(min(min1, min2), min3))
            '  End If
         End If
      Loop
      Close #3
      'pominiecie rynkow ktore nie maja wystarczajaco danych
      If D(rozmiarWierszy) < midDate Then 'D(1) > startDate + 5 Or
         GoTo continue_loop
      End If

      pTick = 0.01 'max(0.0001, TickerEstimation(Increment))   '   # minimal tick increment
      pSpread = 0.006 * 1    '0#   'pTick * 1# '  # koszta (commision+spread)

      ile = rozmiarWierszy 'countStartOutDate
      bestSharpeIn = -100
      Increment = 1000000

      ReDim timeDzien(1 To rozmiarWierszy) As Double
      ReDim timeNoc(1 To rozmiarWierszy) As Double
      ReDim cenaDzien(1 To rozmiarWierszy) As Double
      ReDim cenaNoc(1 To rozmiarWierszy) As Double

      ReDim EMA1(1 To rozmiarWierszy) As Double
      ReDim trendEMA(1 To rozmiarWierszy) As Double
      ReDim H1(1 To rozmiarWierszy) As Double
      ReDim L1(1 To rozmiarWierszy) As Double
      ReDim H11(1 To rozmiarWierszy) As Double
      ReDim L11(1 To rozmiarWierszy) As Double
      ReDim DzienSL(1 To rozmiarWierszy) As Double
      ReDim bazaSL(1 To rozmiarWierszy) As Double
      ReDim CenaBuySL(1 To rozmiarWierszy) As Double
      ReDim CenaShortSL(1 To rozmiarWierszy) As Double
      ReDim kierDzien(1 To rozmiarWierszy) As Double
      ReDim kierNoc(1 To rozmiarWierszy) As Double
      ReDim BuySL(1 To rozmiarWierszy) As Double
      ReDim ShortSL(1 To rozmiarWierszy) As Double
      ReDim Kierunek(1 To rozmiarWierszy) As Double
      ReDim Cena(1 To rozmiarWierszy) As Double
      ReDim ZyskCum(1 To rozmiarWierszy) As Double
      ReDim PL(1 To 1000000) As Double
        
      ileDni = countDays(countmidDate)

      ReDim luka(1 To ileDni) As Double
      ReDim Dzien(1 To ileDni) As Double
      ReDim luka1(1 To ileDni) As Double
      ReDim dzien1(1 To ileDni) As Double
      ReDim luka2(1 To ileDni) As Double
      ReDim dzien2(1 To ileDni) As Double
      
      countDays(1) = 1
      cenaDzien(1) = O(1)
      cenaNoc(1) = O(1)
      Cena(1) = O(1)

        iHourDzien.wide = 1
        iHourNoc.wide = 1
        iEMA.wide = 1
        iSL1.wide = 10
        iSL2.wide = 10
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   OPTYMALIZACJA 1:  wybranie godzin, SL step 10 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        iTryb.min = 1:   iTryb.max = 1: iTryb.step = 1
        iSL1.min = 1:   iSL1.max = 141: iSL1.step = 10
        iSL2.min = 119:   iSL2.max = 119: iSL2.step = 1
        iEMA.min = 1:   iEMA.max = 1: iEMA.step = 1
        iHourDzien.min = 0:   iHourDzien.max = 10: iHourDzien.step = 2
        iHourNoc.min = -10:   iHourNoc.max = 0: iHourNoc.step = 2
        iprogDzien.min = 1:     iprogDzien.max = 1: iprogDzien.step = 1
        iprogNoc.min = 1:     iprogNoc.max = 1: iprogNoc.step = 1

        STRATEGY_BRAVO_M15_SL1
      
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   OPTYMALIZACJA 1:  wybranie godzin, SL step 10 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        iTryb.min = 1:   iTryb.max = 1: iTryb.step = 1
        iSL1.min = 1:   iSL1.max = 141: iSL1.step = 10
        iSL2.min = 119:   iSL2.max = 119: iSL2.step = 1
        iEMA.min = 1:   iEMA.max = 1: iEMA.step = 1
        iHourDzien.min = max(0, iHourDzien.best - iHourDzien.wide): iHourDzien.max = iHourDzien.best + iHourDzien.wide: iHourDzien.step = 1
        iHourNoc.min = iHourNoc.best - iHourNoc.wide: iHourNoc.max = min(0, iHourNoc.best + iHourNoc.wide): iHourNoc.step = 1
        iprogDzien.min = 1:     iprogDzien.max = 1: iprogDzien.step = 1
        iprogNoc.min = 1:     iprogNoc.max = 1: iprogNoc.step = 1

        STRATEGY_BRAVO_M15_SL1
        
        
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   OPTYMALIZACJA 1:  wybranie godzin, SL step 10 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        iTryb.min = 1:   iTryb.max = 1: iTryb.step = 1
        iSL1.min = 1:   iSL1.max = 141: iSL1.step = 10
        iSL2.min = 119:   iSL2.max = 119: iSL2.step = 1
        iEMA.min = 1:   iEMA.max = 1: iEMA.step = 1
        iHourDzien.min = iHourDzien.best: iHourDzien.max = iHourDzien.best: iHourDzien.step = 2
        iHourNoc.min = iHourNoc.best:   iHourNoc.max = iHourNoc.best: iHourNoc.step = 1
        iprogDzien.min = 1:     iprogDzien.max = 1: iprogDzien.step = 1
        iprogNoc.min = 1:     iprogNoc.max = 1: iprogNoc.step = 1

        STRATEGY_BRAVO_M15_SL1
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   OPTYMALIZACJA 3:  prog Dzien !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        iTryb.min = iTryb.best:   iTryb.max = iTryb.best: iTryb.step = 1
        iSL1.min = iSL1.best:   iSL1.max = iSL1.best: iSL1.step = 5
        iSL2.min = 119:   iSL2.max = 119: iSL2.step = 1
        iEMA.min = 1:   iEMA.max = 1: iEMA.step = 1
        iHourDzien.min = iHourDzien.best: iHourDzien.max = iHourDzien.best: iHourDzien.step = 2
        iHourNoc.min = iHourNoc.best:   iHourNoc.max = iHourNoc.best: iHourNoc.step = 1
        iprogDzien.min = 1:     iprogDzien.max = 67: iprogDzien.step = 1
        iprogNoc.min = 1:     iprogNoc.max = 1: iprogNoc.step = 1
 
        STRATEGY_BRAVO_M15_SL1
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   OPTYMALIZACJA 4:  prog Noc !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        iTryb.min = iTryb.best:   iTryb.max = iTryb.best: iTryb.step = 1
        iSL1.min = iSL1.best:   iSL1.max = iSL1.best: iSL1.step = 5
        iSL2.min = 119:   iSL2.max = 119: iSL2.step = 1
        iEMA.min = 1:   iEMA.max = 1: iEMA.step = 1
        iHourDzien.min = iHourDzien.best: iHourDzien.max = iHourDzien.best: iHourDzien.step = 2
        iHourNoc.min = iHourNoc.best:   iHourNoc.max = iHourNoc.best: iHourNoc.step = 1
        iprogDzien.min = iprogDzien.best:     iprogDzien.max = iprogDzien.best: iprogDzien.step = 1
        iprogNoc.min = 1:     iprogNoc.max = 67: iprogNoc.step = 1
 
        STRATEGY_BRAVO_M15_SL1
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   OPTYMALIZACJA 4.5:  WYBRANIE SL 1!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        iTryb.min = iTryb.best:   iTryb.max = iTryb.best: iTryb.step = 1
        iSL1.min = 1:   iSL1.max = 141: iSL1.step = 1
        iSL2.min = 1:   iSL2.max = 1: iSL2.step = 1
        iEMA.min = 1:   iEMA.max = 1: iEMA.step = 2
        iHourDzien.min = iHourDzien.best: iHourDzien.max = iHourDzien.best: iHourDzien.step = 2
        iHourNoc.min = iHourNoc.best:   iHourNoc.max = iHourNoc.best: iHourNoc.step = 1
        iprogDzien.min = iprogDzien.best:     iprogDzien.max = iprogDzien.best: iprogDzien.step = 1
        iprogNoc.min = iprogNoc.best:     iprogNoc.max = iprogNoc.best: iprogNoc.step = 1
 
        STRATEGY_BRAVO_M15_SL1
  
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   OPTYMALIZACJA 8:  GOTOWY BACKTEST !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        iTryb.min = iTryb.best:   iTryb.max = iTryb.best: iTryb.step = 1
        iSL1.min = iSL1.best: iSL1.max = iSL1.best: iSL1.step = 1
        iSL2.min = iSL2.best: iSL2.max = iSL2.best: iSL2.step = 1
        iEMA.min = iEMA.best: iEMA.max = iEMA.best: iEMA.step = 1
        iHourDzien.min = iHourDzien.best: iHourDzien.max = iHourDzien.best: iHourDzien.step = 2
        iHourNoc.min = iHourNoc.best:   iHourNoc.max = iHourNoc.best: iHourNoc.step = 1
        iprogDzien.min = iprogDzien.best:     iprogDzien.max = iprogDzien.best: iprogDzien.step = 1
        iprogNoc.min = iprogNoc.best:     iprogNoc.max = iprogNoc.best: iprogNoc.step = 1
 
        STRATEGY_BRAVO_M15_SL1
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
               
     
      For m = 40 To rozmiarWierszy - 31
    '     If ZyskCum(m) <> ZyskCum(m - 1) Then
         Print #5, D(m) & ";" & t(m) & ";" & O(m) & ";" & h(m) & ";" & l(m) & ";" & C(m) & ";" & ZyskCum(m) & ";" & Cena(m) & ";" & Kierunek(m) & ";" & timeDzien(m) & ";" & timeNoc(m) & ";" & kierDzien(m) & ";" & kierNoc(m) & ";" & cenaDzien(m) & ";" & cenaNoc(m) & ";" & CenaBuySL(m) & ";" & CenaShortSL(m) & ";" & H11(m) & ";" & L11(m)
     ' End If
      Next m
      '  On Error GoTo MojaProce_Error
MojaProce_Error:
      Open "D:\bravoD1\errors\errors.txt" For Append As #10
      Print #10, nazwaRynku & ";" & "Błąd : ( " & Err.Number & " ) " & Err.Description & vbCrLf & _
         "Procedura : " & "MojaProce " & m, vbExclamation
      Close #10
   
continue_loop:
      Close #5
      Close #6
      '     Close #7
      strplik = Dir
  ' Loop
     Next R
   '----------------------------------------------------
   With Application
      .Calculation = xlCalculationAutomatic
      .ScreenUpdating = True
      .CutCopyMode = False
   End With

End Sub

Sub STRATEGY_BRAVO_M15_SL1()

   '  On Error GoTo MojaProce_Error

   bestSharpeIn = -100
   optymalizacja = optymalizacja + 1
   '@@@@@@@@@@@@@@@@@@@@@@@ FOR HOUR ITERATION @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
   For HourDzien = iHourDzien.min To iHourDzien.max Step iHourDzien.step
      For HourNoc = iHourNoc.min To iHourNoc.max Step iHourNoc.step


         '##########################################################
         '####################### SORTING ALGORITHM ################
         '##########################################################
         'utworzenie zmiennych do sortowania
         For i = 2 To rozmiarWierszy - 30
            If i < 30 Then
               cenaDzien(i) = IIf(IIf(nowNewday(max(1, i - HourDzien)) = 1, 1, 0) = 1, O(i), cenaDzien(i - 1))
               cenaNoc(i) = IIf(IIf(now16(max(1, i - HourNoc)) = 1, 1, 0), O(i), cenaNoc(i - 1))
            Else
               cenaDzien(i) = IIf(IIf(nowNewday(i - HourDzien) = 1, 1, 0) = 1, O(i), cenaDzien(i - 1))
               cenaNoc(i) = IIf(IIf(now16(i - HourNoc) = 1, 1, 0), O(i), cenaNoc(i - 1))
            End If
    
            If i < countmidDate Then
               numerDnia = countDays(i)
               If nowNewday(i) = 1 Then
                  luka(numerDnia) = cenaDzien(i) / cenaNoc(i) - 1
                  dzien2(numerDnia) = cenaNoc(i) / cenaDzien(i - 1) - 1
               End If
               If now16(i) = 1 Then
                  Dzien(numerDnia) = cenaNoc(i) / cenaDzien(i) - 1
               End If
            End If
         Next i

         'TABLICE DO SORTOWANIA
         luka1 = luka:               dzien1 = Dzien:             luka2 = luka
         lewy = LBound(luka1, 1):    prawy = UBound(luka1, 1):   koniec = UBound(luka1, 1)
            
         ''======ALGO SORTOWANIA!!!!!!!!!!!
         SortowanieDwoch luka1, dzien1, lewy, prawy

         progDzienSort = wynikSortowania(ileDni, luka1, dzien1, sredniZyskF, kierunekF, progF)
         kierunekDzien = kierunekF
         SortowanieDwoch dzien2, luka2, lewy, prawy
         progNocSort = wynikSortowania(ileDni, dzien2, luka2, sredniZyskF, kierunekF, progF)
         kierunekNoc = kierunekF

         '@@@@@@@@@@@@@@@@@@@@@@@ FOR STREGY TRYB @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
         For tryb = iTryb.min To iTryb.max Step iTryb.step
            '@@@@@@@@@@@@@@@@@@@@@@@ FOR STOP LOSS   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
            For s = iEMA.min To iEMA.max Step iEMA.step
               For q = iSL1.min To iSL1.max Step iSL1.step
                  For w = q To q Step iSL2.step
                     For g = iprogDzien.min To iprogDzien.max Step iprogDzien.step
                        For f = iprogNoc.min To iprogNoc.max Step iprogNoc.step
                            
                           iteracja = iteracja + 1

                           '##########################################################
                           '####################### STRATEGIA ######################
                           '##########################################################
                           onlyBuy = 0
                           pSL1 = mnoznik(q): pSL2 = mnoznik(w)
                           alfa = alfaEMA(s)
                           trybNoc = a(tryb): trybDzien = b(tryb)
                           trybSL_L = SL_L(tryb): trybSL_S = SL_S(tryb)
                           trybSL_Reverse = SL_Double(tryb)
                           pKierDzien = kierunekDzien: pKierNoc = kierunekNoc
                           pProgDzien = progDzienSort + prog(g): pProgNoc = progNocSort + prog(f)
                                        
                           trade = 0
                           '@@@@@@@@@@@@@@@@@@@@@@@ FOR M ITERATION  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
                           For m = 2 To rozmiarWierszy - 30 '@@@@@ PETLA FOR @@@@@
                              If m < 30 Then
                                 timeDzien(m) = IIf(nowNewday(max(1, m - HourDzien)) = 1, 1, 0)
                                 timeNoc(m) = IIf(now16(max(1, m - HourNoc)) = 1, 1, 0)
                              Else
                                 timeDzien(m) = IIf(nowNewday(m - HourDzien) = 1, 1, 0)
                                 timeNoc(m) = IIf(now16(m - HourNoc) = 1, 1, 0)
                              End If
    
                              EMA1(m) = IIf(D(m) = D(m + 1), EMA1(m - 1), (1 / alfa) * C(m) + (1 - 1 / alfa) * EMA1(m - 1)) 'EMA(C(m), EMA1(m - 1), 1 / alfa, D(m) <> D(m + 1))
                              trendEMA(m) = IIf(D(m) <> D(m + 1), IIf(C(m) > EMA1(m), 1, -1), trendEMA(m - 1))
                              H1(m) = IIf(nowNewday(m) = 1 Or h(m) > H1(m - 1), h(m), H1(m - 1))
                              L1(m) = IIf(nowNewday(m) = 1 Or l(m) < L1(m - 1), l(m), L1(m - 1))
                              H11(m) = IIf(D(m) <> D(m - 1), H1(m - 1), H11(m - 1))
                              L11(m) = IIf(D(m) <> D(m - 1), L1(m - 1), L11(m - 1))

                              '^^^^^^^^^^ DZIEN ^^^^^^^^^^
                              If timeDzien(m) = 1 Then
                                 kierDzien(m) = IIf(trybDzien = 1, Sgn((cenaDzien(m) / cenaNoc(m) - 1 - pProgDzien) * pKierDzien), IIf(trybDzien = 0, 0, IIf(trybDzien = 2, Kierunek(m - 1), Kierunek(m - 1) * -1))) '   #prognoza Dzien
                                 'kierDzien(m) = IIf(onlyBuy, IIf(kierDzien(m) < 0, 0, kierDzien(m)), kierDzien(m))
                                 '^^^^^^^^^^ SL ^^^^^^^^^^^^^
                                ' DzienSL(m) = 1
                                 CenaBuySL(m) = O(m) + ((H11(m) - L11(m)) * IIf(trendEMA(m) = 1, pSL1, pSL2) * 1 / pTick) * pTick 'max(O(m),                                  '#cena Buy SL
                                 CenaShortSL(m) = O(m) - ((H11(m) - L11(m)) * IIf(trendEMA(m) = 1, pSL2, pSL1) * 1 / pTick) * pTick ' min(O(m), )                                 '  #cena Short SL

                              Else
                                 DzienSL(m) = DzienSL(m - 1)
                                 CenaBuySL(m) = CenaBuySL(m - 1)                               '#cena Buy SL
                                 CenaShortSL(m) = CenaShortSL(m - 1)                               '  #cena Short SL
                              End If
                              
                              If timeDzien(m - 1) = 1 Then
                                 DzienSL(m) = 1
                              End If
    
                              '^^^^^^^^^^ LUKA ^^^^^^^^^^^
                              If timeNoc(m) = 1 Then
        
                                 kierNoc(m) = IIf(trybNoc = 1, Sgn((cenaNoc(m) / cenaDzien(m) - 1 - pProgNoc) * pKierNoc), IIf(trybNoc = 0, 0, IIf(trybNoc = 2, Kierunek(m - 1), Kierunek(m - 1) * -1))) '  #prognoza Noc
                                 'kierNoc(m) = IIf(onlyBuy, IIf(kierNoc(m) < 0, 0, kierNoc(m)), kierNoc(m))
                                 DzienSL(m) = 0
                              Else
                                 DzienSL(m) = DzienSL(m - 1)
                              End If
         
                              If DzienSL(m) = 1 Then
                                 '  BuySL(m) = (O(m) >= CenaBuySL(m)) And trybSL_L  '  #odpalony SL na L
                                 '  ShortSL(m) = (O(m) <= CenaShortSL(m)) And trybSL_S '  #odpalony SL na S
                                 BuySL(m) = (h(m) >= max(O(m), CenaBuySL(m))) And trybSL_L '  #odpalony SL na L
                                 ShortSL(m) = (l(m) <= min(O(m), CenaShortSL(m))) And trybSL_S '  #odpalony SL na S
                              End If
    
                              '^^^^^^^^^^ CALOSC ^^^^^^^^^^^
                              Kierunek(m) = IIf(timeDzien(m), kierDzien(m), IIf(timeNoc(m), kierNoc(m), IIf(BuySL(m) And Kierunek(m - 1) < 1, 1, IIf(ShortSL(m) And Kierunek(m - 1) > -1, -1, Kierunek(m - 1)))))
                              Kierunek(m) = IIf(Abs(O(m) / O(m + 1) - 1) > 0.05 Or m = rozmiarWierszy - 32, 0, IIf(Abs(O(m) / O(m - 1) - 1) > 0.05, Kierunek(max(1, m - 2)), Kierunek(m)))
                          
                              Cena(m) = IIf(Kierunek(m) <> Kierunek(m - 1), IIf(BuySL(m), CenaBuySL(m), IIf(ShortSL(m), CenaShortSL(m), O(m))), Cena(m - 1))
                              ZyskCum(m) = ZyskCum(m - 1) + ((Cena(m) - Cena(m - 1)) / Cena(m - 1)) * Kierunek(m - 1) - Abs(Kierunek(m) - Kierunek(m - 1)) * (0.01 / O(m) + min(0.005, max(1, pSpread * 10000 / Cena(m)) / 10000)) '
                              

                            
                              
                              If ZyskCum(m) <> ZyskCum(m - 1) Then
                              
                                 trade = trade + 1
                                 If D(m) < startOutDate Then
                                    tradeIn = trade
                                 End If
                                 
                                 PL(trade) = Round(ZyskCum(m) - ZyskCum(m - 1), 8) + 1
                              End If
                              
                              
                           Next m

                           '##########################################################
                           '####################### WYNIKI ######################
                           '##########################################################
                           
                           ZyskIn = ZyskCum(countmidDate) 'Sum1(zysk())                              '  #suma ZYSKu w okresie In sample
                           ZyskMid = ZyskCum(countStartOutDate) - ZyskIn 'Sum1(zysk())                              '  #suma ZYSKu w okresie In sample
                           ZyskOut = ZyskCum(rozmiarWierszy - 30) - ZyskCum(countStartOutDate)
                           SharpeRatioIN = ZyskIn 'Mean1(1, trade, PL()) / StdDev1(1, trade, PL()) '  #SharpeRatio w okresie In sample
                           bestZyskIn = IIf(SharpeRatioIN > bestSharpeIn And ZyskMid > 0, ZyskIn, bestZyskIn)
                           iSL1.best = IIf(SharpeRatioIN > bestSharpeIn And ZyskMid > 0, q, iSL1.best)
                           iSL2.best = IIf(SharpeRatioIN > bestSharpeIn And ZyskMid > 0, w, iSL2.best)
                           iEMA.best = IIf(SharpeRatioIN > bestSharpeIn And ZyskMid > 0, s, iEMA.best)
                           iHourDzien.best = IIf(SharpeRatioIN > bestSharpeIn And ZyskMid > 0, HourDzien, iHourDzien.best)
                           iHourNoc.best = IIf(SharpeRatioIN > bestSharpeIn And ZyskMid > 0, HourNoc, iHourNoc.best)
                           iprogDzien.best = IIf(SharpeRatioIN > bestSharpeIn And ZyskMid > 0, g, iprogDzien.best)
                           iprogNoc.best = IIf(SharpeRatioIN > bestSharpeIn And ZyskMid > 0, f, iprogNoc.best)
                           iTryb.best = IIf(SharpeRatioIN > bestSharpeIn And ZyskMid > 0, tryb, iTryb.best)
                           bestSharpeIn = IIf(SharpeRatioIN > bestSharpeIn And ZyskMid > 0, SharpeRatioIN, bestSharpeIn)
                        Next f
                     Next g
                  Next w
               Next q
            Next s
         Next tryb
      Next HourNoc
   Next HourDzien

   SharpeRatioIN = StdDev1(1, tradeIn, PL()) '  #SharpeRatio w okresie In sample
   SharpeRatioOUT = 0 'Val(IIf(trade - tradeIn + 1 > 2, Mean1(tradeIn + 1, trade, PL()) / StdDev1(tradeIn + 1, trade, PL()), 0)) '  #SharpeRatio w okresie In sample

   wyniki = nazwaRynku & ";" & optymalizacja & ";" & iteracja & ";" & Round(Timer - startTime, 2) & ";" & startDate & ";" & midDate & ";" & pTick & ";" & pSpread _
      & " best; " & iSL1.best & ";" & iSL2.best & ";" & iEMA.best & ";" & iHourDzien.best & ";" & iHourNoc.best & ";" & pKierDzien & ";" & pKierNoc & ";" & Round(progDzienSort + prog(iprogDzien.best), 5) & ";" & Round(progNocSort + prog(iprogNoc.best), 5) & ";" & iTryb.best & " wyniki; " & Round(bestZyskIn, 4) & ";" & Round(ZyskIn, 4) & ";" & Round(ZyskMid, 4) & ";" & Round(ZyskOut, 4) & ";" & SharpeRatioIN & ";" & SharpeRatioOUT
   Print #6, wyniki
 
MojaProce_Error:
   Open "D:\bravoD1\errors\errors.txt" For Append As #10
   Print #10, nazwaRynku & ";" & "Błąd : ( " & Err.Number & " ) " & Err.Description & vbCrLf & _
      "Procedura : " & "MojaProce " & m, vbExclamation
   Close #10
   
End Sub





Public Function TickerEstimation(ByVal Increment As Double) As Double              'linia 1
   '---------------------------------------------------------------------------------------
   ' Method : TickerEstimation
   ' Author : Jakub Medon
   ' Date   : 2016-05-28
   ' Purpose: Find lowest increment for current market
   '---------------------------------------------------------------------------------------
   Dim tickery(1 To 19) As Double
   Dim tickerMin(1 To 19) As Double
   For i = 1 To 19 'zaimportowanie tablicy znaki2
      tickery(i) = Sheets("ustawienia").Cells(i + 1, 9)
      tickerMin(i) = Sheets("ustawienia").Cells(i + 1, 10)
   Next i
   For i = 1 To 19
      If Increment < tickerMin(i) Then
         TickerEstimation = max(0.0001, tickery(i - 1))
         Exit For
      End If
   Next i
    
End Function

Public Function countRowsInFile(ByVal PATCHstr As String, ByVal strplik As String, delimiter As String, ByVal startDate As Double, ByVal midDate As Double, ByVal startOutDate As Double) As Double              'linia 1
    'liczy ilosc wierszy w pliku
    'Set fs = CreateObject("Scripting.FileSystemObject")
    'ChDir PATCHstr
    ile = 0
    stopmidDate = 1
    stopstartOutDate = 1
    countEndDay = -100
    'sprawdzenie rozmiaru tablicy
    ile = ile + 1
    Open PATCHstr & "\" & strplik For Input As #3
    rozmiarWierszy = 0
    Do While Not EOF(3)
        Line Input #3, Textline
        ArrCells = Split(Textline, delimiter) '","
        
 
        If Val(Right(ArrCells(0), 4)) > 915 And Val(Right(ArrCells(0), 4)) < 1615 Then
            If Val(Left(ArrCells(0), 8)) > startDate Then
                rozmiarWierszy = rozmiarWierszy + 1
            End If
            If Val(Left(ArrCells(0), 8)) >= midDate And stopmidDate Then
                countmidDate = rozmiarWierszy
                stopmidDate = 0
            End If
            If Val(Left(ArrCells(0), 8)) >= startOutDate And stopstartOutDate Then
                countStartOutDate = rozmiarWierszy
                stopstartOutDate = 0
            End If
        End If
    Loop
    If stopmidDate = 1 Then
        countmidDate = rozmiarWierszy
    End If
    If stopstartOutDate = 1 Then
        countStartOutDate = rozmiarWierszy
    End If
    Close #3
    countRowsInFile = rozmiarWierszy
End Function




Public Function wynikSortowania(ByVal ile As Double, ByRef zmienna() As Double, ByRef zmienna2() As Double, ByRef sredniZyskF As Double, ByRef kierunekF As Double, ByRef progF As Double) As Double

   ReDim Zysk(0 To ile) As Double
   Dim minF  As Double 'minimum
   Dim maxF  As Double ' maximum
   Dim absF  As Double ' abs zmienna()
   Dim progMinF  As Double ' prog minimum
   Dim progMaxF  As Double '  prog maximum
   Dim zyskK  As Double ' zysk na koniec
   minF = 10000000000#
   maxF = -100000000000#
   'Dim kierunekF ' 1-trend -1- anty trend
   'Dim sredniZyskF ' sredni zysk
   'Dim prog ' finalny prog
   Dim stat(0 To 10) As Double
   Dim wynik(1 To 1) As Double
   '=====POLICZENIE ZYSKU I INNYCH STATYSTYK
   For m = 1 To ile - 1
      '====zysk
      Zysk(m) = Val(zmienna2(m) + Zysk(max(1, m - 1)))
      '====min
      If Val(Zysk(m)) < minF Then '
         minF = Zysk(m)
         progMinF = zmienna(m)
      End If
      '===max
      If Val(Zysk(m)) > maxF Then  '
         maxF = Zysk(m)
         progMaxF = zmienna(m)
      End If
      '===abs
      absF = absF + Abs(zmienna2(m))
   Next m
            
   '====wynik na koniec

   zyskK = Zysk(ile - 1)
   '====kierunek
   If maxF + Abs(zyskK - maxF) > -minF + Abs(zyskK - minF) Then
      kierunekF = -1
   Else
      kierunekF = 1
   End If
   '====sredni zysk
   If kierunekF = 1 Then
      sredniZyskF = Val(Round(Val(((-minF + Abs(zyskK - minF)) / Val(absF + 1))), 3))
   Else
      sredniZyskF = Val(Round(Val(((maxF + Abs(zyskK - maxF)) / Val(absF + 1))), 3))
            
   End If
        
   If kierunekF = 1 Then
      wynikSortowania = progMinF 'prog
   Else
      wynikSortowania = progMaxF
   End If
        

             
End Function
Public Sub SortowanieDwoch(tabl, tabl2, lngMin, lngMax)
   On Error Resume Next
   Dim l As Long
   Dim p As Long
   Dim med
   Dim Temp
   Dim temp1

    
   If IsEmpty(tabl) Then
      Exit Sub
   End If
   If InStr(TypeName(tabl), "()") < 1 Then  'IsArray() is somewhat broken: Look for brackets in the type name
      Exit Sub
   End If
   If lngMin = -1 Then
      lngMin = LBound(tabl)
   End If
   If lngMax = -1 Then
      lngMax = UBound(tabl)
   End If
   If lngMin >= lngMax Then    ' no sorting required
      Exit Sub
   End If

   l = lngMin
   p = lngMax


   If lngMin < lngMax Then
      l = lngMin
      p = lngMax
      med = tabl(l)
      Do
         While tabl(l) < med
            l = l + 1
         Wend
         While tabl(p) > med
            p = p - 1
         Wend
         If l <= p Then
            Temp = tabl(l)
            tabl(l) = tabl(p)
            tabl(p) = Temp
    
            temp1 = tabl2(l)
            tabl2(l) = tabl2(p)
            tabl2(p) = temp1
 
 
    
            l = l + 1
            p = p - 1
         End If
      Loop Until l >= p
      Call SortowanieDwoch(tabl, tabl2, lngMin, p)
      Call SortowanieDwoch(tabl, tabl2, l, lngMax)
   End If
End Sub









